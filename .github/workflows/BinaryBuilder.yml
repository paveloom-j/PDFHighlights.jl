name: BinaryBuilder

on:
  push:
    branches:
      - binaries

env:
  package_name: PDFHighlights_jll
  path_to_package: /home/runner/.julia/dev/PDFHighlights_jll

jobs:
  BinaryBuilder:
    name: Build Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the branch
        uses: actions/checkout@v2
      - name: Install Julia
        uses: julia-actions/setup-julia@latest
        with:
          version: 1.5
          arch: x64
      - name: Install BinaryBuilder
        run: julia -e 'using Pkg; Pkg.add("BinaryBuilder")'
      - name: Build Binaries
        run: julia --color=yes build_tarballs.jl --verbose --deploy=local
      - name: Test the package
        run: |
          cp -r test ${{ env.path_to_package }}
          julia --project="${{ env.path_to_package }}" -e 'using Pkg;
                    Pkg.develop(path="${{ env.path_to_package }}")
                    Pkg.add("Test"); Pkg.test("${{ env.package_name }}")'
      - name: Upload the artifacts
        uses: actions/upload-artifact@v2
        with:
          name: binaries
          path: |
            products/*.tar.gz
            ${{ env.path_to_package }}
